<!DOCTYPE html>
<html lang="en">
<head>
  <title>Saving Throws</title>
  <link rel="stylesheet" href="dnd.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    const state = { editions: [], currentEdition: "" }

    function loadClasses(forEdition) {
      elem = $('#className')
      $(elem).empty()
      for (let e in state.editions) {
        const ed = state.editions[e]
        if (ed.edition == forEdition) {
          for (let c in ed.classes) {
            console.log(`class ${ed.classes[c]}`)
            $(elem).append(`<option value="${ed.classes[c]}">${ed.classes[c]}</option>`)
          }
        }
      }
    }
    
    function loadEditions(data) {
      state.editions = data
      elem = $('#edition')
      $(elem).empty()
      for (let e in state.editions) {
        $(elem).append(`<option value="${data[e].edition}">${data[e].text}</option>`)
      }
      if (state.editions.length > 0) {
        loadClasses(state.editions[0].edition)
      }
    }

    function roll() {
      const x = $('#howMany')
      console.log(x.innerHTML)
      const edition = $('#edition').val()
      const className = $('#className').val()
      const level = $('#level').val()
      const howMany = $('#howMany').val()

      if (isNaN(level) || isNaN(howMany)) return

      console.log(`Calling api at ./rollsaves/${howMany}/${edition}/${className}/${level}`)
      $.get(`./rollsaves/${howMany}/${edition}/${className}/${level}`, (data) => {
        let elem = $('#saves')
        $(elem).empty()
        for (let i=0; i < data.saves.length; i++) {
          $(elem).append(`${data.saves[i].effect}: ${data.saves[i].need}<br />`)
        }
        elem = $('#results')
        $(elem).empty()
        for (let n=0; n < howMany; n++) {
          $(elem).append(`Rolled: ${data.rolls[n].roll}, saved: `)
          for (let i=0; i < data.saves.length; i++) {
            if (i > 0) $(elem).append(', ')
            $(elem).append(`${data.rolls[n].saves[i]}`)
          }
          $(elem).append(`<br />`)
        }
      })
    }

    $(function() {    // document.ready
      $.get('./classes', (data) => {
        loadEditions(data)
      })
    })
   </script>
   </head>
<body>
  <a href="index.html">< Home</a>
  <h1>Saving Throws</h1>
  <p>Rolls multiple saving throws and reports successes and failures. 
  </p>
  <div style="margin:10px; width: 400px; text-align: center;">
    <label for="edition">Book:</label>
    <select name="edition" id="edition" onchange="loadClasses(this.value)">
    </select><br />
    <label for="className">Class:</label>
      <select id="className" type="text" onchange="selectClass(this.value)">
        <option value="0"></option>
      </select><br />
    <label for="level">Level:</label>       <input id="level" type="text"></input><br />
    <label for="howMany">How Many:</label>  <input id="howMany" type="text"></input><br />
    <button type="button" onclick="roll()">Roll</button>
  </div>

  <div class="float-container">
    <div class="float-child">
      <div id="saves"></div>
    </div>
    <div class="float-child">
      <div id="results"></div>
    </div>
  </div>
</body>
